name: Tests-Windows

on: [ push ]

env:
  BUILD_TYPE: Release

jobs:
  test:
    name: Windows testing
    
    runs-on: windows-2022

    env:
      PROJ_LIB: ${{github.workspace}}/bin/bin

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Cache Conan
      id: cache-conan
      uses: actions/cache@v3
      with:
        path: C:/Users/runneradmin/.conan
        key: ${{ runner.os }}-conan

    - name: Install Conan
      run: |
        python -m pip install --upgrade pip
        pip install wheel conan
        
        # gitlab support (wxwidgets, mysql, gdal)
        conan remote add gitlab https://gitlab.com/api/v4/packages/conan
        
        # create default profile with libstdc++11
        conan profile new default --detect
        conan profile update settings.compiler.cppstd=17 default

    - name: Install libraries
      run: |
        mkdir ${{github.workspace}}/bin
        cd ${{github.workspace}}/bin
        conan install .. -o unit_test=True --build=missing

    - name: Build
      working-directory: ${{github.workspace}}/bin
      run: conan build ..

    - name: Run tests
      working-directory: ${{github.workspace}}/bin
      run: bin/UnitTests
